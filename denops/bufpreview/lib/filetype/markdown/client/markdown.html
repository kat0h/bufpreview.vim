<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=smoothscroll"></script>

    <!-- CSS for MarkDown -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/xcode.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markdown-it-texmath/css/texmath.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">

    <title>Loading...</title>

    <script>
      const closeWindow = () => {
        window.open('about:blank','_self').close()
        document.getElementById('render').innerHTML = '<h1 align="center">Connection closed</h1>'
        document.title = "Connection closed"
      }

      // 行に最も近い要素を探索
      // min = 0
      //   ページの最後尾
      const sb = (res) => {
        let min = res.cursorLine.linePos
        while (true) {
          let e = document.getElementById(`source-line-${min}`)
          if (e==null) {
            min = min - 1
          } else {
            break
          }
          if (min < 1) {
            break
          }
        }
        max = res.cursorLine.linePos
        while (true) {
          e = document.getElementById(`source-line-${max}`)
          if (e==null) {
            max = max + 1
          } else {
            break
          }
          if (max >= res.cursorLine.bufLengh) {
            break
          }
        }
        return [min, max]
      }

      const getOfs = (l, res) => {
        if (l == 0) {
          return 0
        }
        if (l >= res.cursorLine.bufLengh) {
          return document.getElementById('render').clientHeight
        }
        e = document.getElementById(`source-line-${l}`).getBoundingClientRect().top + window.pageYOffset
        return e
      }

      const socket = new WebSocket('ws://localhost:'+location.port+'/ws')
      socket.onerror = function(_) {
        document.getElementById('render').innerHTML = '<h1 align="center">Connection closed</h1>'
        document.title = "Connection closed"
      }
      socket.onclose = function() {
        closeWindow()
      }
      socket.addEventListener('message', function (event) {
        let res = JSON.parse(event.data)
        if (res.bufname != undefined) {
          document.title = res.bufname
        }
        if (res.buf != undefined) {
          document.getElementById('render').innerHTML = res.buf
        }
        if (res.cursorLine != undefined) {
          const e = sb(res)
          const c = e[0]
          const d = e[1]
          let pos
          if (c == d) {
            pos = getOfs(c, res)
          } else {
            const ofs = e.map((l) => getOfs(l, res))
            const a = ofs[0]
            const b = ofs[1]
            // スクロール位置の計算
            pos = a + (res.cursorLine.linePos - c) * ((b - a) / ((d - c)) )
          }
          window.scrollTo({
            left: 0,
            top: pos - document.getElementsByTagName('html')[0].clientHeight / 2,
            behavior: 'smooth'
          })
        }
        if (res.connect != undefined && res.connect == "close") {
          closeWindow()
        }
      })

    </script>
    <style>
      html {
        scroll-behavior: smooth;
      }
      .view {
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="view">
      <article class="markdown-body" id="render">
        <h1 align="center">Loading...</h1>
      </article>
    <div>
  </body>
</html>
